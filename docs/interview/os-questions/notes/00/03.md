# ç®€è¿° select, poll, epoll çš„ä½¿ç”¨åœºæ™¯ä»¥åŠåŒºåˆ«ï¼Œepoll ä¸­æ°´å¹³è§¦å‘ä»¥åŠè¾¹ç¼˜è§¦å‘æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

æ‰€è°“ I/O å¤šè·¯å¤ç”¨æŒ‡çš„å°±æ˜¯ select/poll/epoll è¿™ä¸€ç³»åˆ—çš„å¤šè·¯é€‰æ‹©å™¨ï¼šæ”¯æŒå•ä¸€çº¿ç¨‹åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆI/O äº‹ä»¶ï¼‰ï¼Œé˜»å¡ç­‰å¾…ï¼Œå¹¶åœ¨å…¶ä¸­æŸä¸ªæ–‡ä»¶æè¿°ç¬¦å¯è¯»å†™æ—¶æ”¶åˆ°é€šçŸ¥ã€‚ I/O å¤ç”¨å…¶å®å¤ç”¨çš„ä¸æ˜¯ I/O è¿æ¥ï¼Œè€Œæ˜¯å¤ç”¨çº¿ç¨‹ï¼Œè®©ä¸€ä¸ª thread of control èƒ½å¤Ÿå¤„ç†å¤šä¸ªè¿æ¥ï¼ˆI/O äº‹ä»¶ï¼‰ã€‚

# select

ä¸‹é¢æ˜¯ä¸€ä¸ªselectä¾‹å­ï¼Œåˆ›å»º 5 ä¸ªå­è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹è¿æ¥åˆ°æœåŠ¡å™¨å¹¶å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ä½¿ç”¨ accept ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œselect ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°åº”è¯¥æ˜¯ä¸‰ä¸ªé›†åˆä¸­ä»»ä½•ä¸€ä¸ªä¸­ç¼–å·æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦åŠ ä¸Š 1ã€‚åˆ›å»ºä¸€ç»„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œè°ƒç”¨ select å¹¶åœ¨è¿”å›æ—¶æ£€æŸ¥å“ªä¸ªæ–‡ä»¶æè¿°ç¬¦å·²å‡†å¤‡å¥½è¯»å–ã€‚select è¿”å›æ—¶ï¼Œ å°†é›†åˆæ›´æ”¹ä¸ºä»…åŒ…å«å‡†å¤‡å¥½çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡è¿­ä»£æ—¶å†æ¬¡æ„å»ºè¯¥é›†åˆã€‚

``` c
#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <wait.h>
#include <signal.h>
#include <errno.h>
#include <sys/select.h>
#include <sys/time.h>
#include <unistd.h>

#define MAXBUF 256

void child_process(void)
{
  sleep(2);
  char msg[MAXBUF];
  struct sockaddr_in addr = {0};
  int n, sockfd,num=1;
  srandom(getpid());
  /* Create socket and connect to server */
  sockfd = socket(AF_INET, SOCK_STREAM, 0);
  addr.sin_family = AF_INET;
  addr.sin_port = htons(2000);
  addr.sin_addr.s_addr = inet_addr("127.0.0.1");

  connect(sockfd, (struct sockaddr*)&addr, sizeof(addr));

  printf("child {%d} connected \n", getpid());
  while(1){
        int sl = (random() % 10 ) +  1;
        num++;
     	sleep(sl);
  	sprintf (msg, "Test message %d from client %d", num, getpid());
  	n = write(sockfd, msg, strlen(msg));	/* Send message */
  }

}

int main()
{
  char buffer[MAXBUF];
  int fds[5];
  struct sockaddr_in addr;
  struct sockaddr_in client;
  // ç”¨äºè®°å½•æœ€å¤§çš„fdä½ç½®
  int addrlen, n,i,max=0;;
  int sockfd, commfd;
  fd_set rset;
  for(i=0;i<5;i++)
  {
  	if(fork() == 0)
  	{
  		child_process();
  		exit(0);
  	}
  }

  sockfd = socket(AF_INET, SOCK_STREAM, 0);
  memset(&addr, 0, sizeof (addr));
  addr.sin_family = AF_INET;
  addr.sin_port = htons(2000);
  addr.sin_addr.s_addr = INADDR_ANY;
  bind(sockfd,(struct sockaddr*)&addr ,sizeof(addr));
  listen (sockfd, 5); 
  // åˆ›å»º5ä¸ªæ–‡ä»¶æè¿°ç¬¦
  for (i=0;i<5;i++) 
  {
    memset(&client, 0, sizeof (client));
    addrlen = sizeof(client);
    // å£°æ˜æ–‡ä»¶æè¿°ç¬¦
    fds[i] = accept(sockfd,(struct sockaddr*)&client, &addrlen);
    if(fds[i] > max)
    	max = fds[i];
  }
  
  while(1){
    // ç”±äºselectåçš„rsetä¼šè¢«ç½®ä½ï¼Œæ‰€æœ‰æ¯æ¬¡å¾ªç¯éœ€è¦å¯¹rsetç½®ç©ºï¼Œç„¶åå†å°†fdsèµ‹ç»™rset
	FD_ZERO(&rset);
  	for (i = 0; i< 5; i++ ) {
  		FD_SET(fds[i],&rset);
  	}

  puts("round again");
    // rsetæ˜¯ä¸€ä¸ªbitmap  
    // é˜»å¡ï¼Œæ¯æ¬¡éœ€è¦æŠŠfdä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ 
    // å½“æœ‰I/Oæ•°æ®æ—¶ï¼Œselectè¿”å›ï¼Œå¹¶ä¸”å°†rsetç½®ä½ï¼Œæ²¡æ•°æ®çš„ä½ä¼šè¢«æ¸…ç©º  
	select(max+1, &rset, NULL, NULL, NULL);
    // éå†ï¼Œåˆ¤æ–­å“ªä¸ªfdè¢«ç½®ä½
	for(i=0;i<5;i++) {
		if (FD_ISSET(fds[i], &rset)){
			memset(buffer,0,MAXBUF);
            // è¯»æ•°æ®
			read(fds[i], buffer, MAXBUF);
			puts(buffer);
		}
	}	
  }
  return 0;
}
```

ç†è§£ select çš„å…³é”®åœ¨äºç†è§£ fd_setï¼Œä¸ºè¯´æ˜æ–¹ä¾¿ï¼Œå– fd_set é•¿åº¦ä¸º 1 å­—èŠ‚ï¼Œfd_set ä¸­çš„æ¯ä¸€ bit å¯ä»¥å¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ fdï¼Œåˆ™ 1 å­—èŠ‚é•¿çš„ fd_set æœ€å¤§å¯ä»¥å¯¹åº” 8 ä¸ª fdã€‚select çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š

1.æ‰§è¡Œ FD_ZERO(&set), åˆ™ set ç”¨ä½è¡¨ç¤ºæ˜¯ 0000,0000

2.è‹¥ fdï¼5, æ‰§è¡Œ FD_SET(fd, &set); å set å˜ä¸º 0001,0000(ç¬¬ 5 ä½ç½®ä¸º 1)

3.å†åŠ å…¥ fdï¼2, fd=1ï¼Œåˆ™ set å˜ä¸º 0001,0011

4.æ‰§è¡Œ select(6, &set, 0, 0, 0) é˜»å¡ç­‰å¾…ï¼ˆè¿™é‡Œmaxæ˜¯5+1ï¼Œè¿™æ˜¯å› ä¸ºsetæœ€å¤§åªèƒ½æ˜¯5ï¼Œå†…æ ¸æ²¡å¿…è¦æŠŠæ‰€æœ‰setä½éƒ½å–å‡ºæ¥ï¼Œåªéœ€è¦æœ€å¤§åˆ°6çš„ä½ç½®ï¼‰

5.è‹¥ fd=1, fd=2 ä¸Šéƒ½å‘ç”Ÿå¯è¯»äº‹ä»¶ï¼Œåˆ™ select è¿”å›ï¼Œæ­¤æ—¶ set å˜ä¸º 0000,0011 (æ³¨æ„ï¼šæ²¡æœ‰äº‹ä»¶å‘ç”Ÿçš„ fd=5 è¢«æ¸…ç©º)

æ ¹æ®ä¸Šé¢ä¾‹å­æˆ‘ä»¬å¯ä»¥å¾—å‡ºselectçš„ç‰¹ç‚¹ï¼š

- å¯ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°å–å†³äº sizeof(fd_set) çš„å€¼ã€‚å‡è®¾æœåŠ¡å™¨ä¸Š sizeof(fd_set)ï¼512ï¼Œæ¯ bit è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ™æœåŠ¡å™¨ä¸Šæ”¯æŒçš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ˜¯ 512*8=4096ã€‚
  
- å°† fd åŠ å…¥ select ç›‘æ§é›†çš„åŒæ—¶ï¼Œè¿˜è¦å†ä½¿ç”¨ä¸€ä¸ªæ•°æ®ç»“æ„ array ä¿å­˜æ”¾åˆ° select ç›‘æ§é›†ä¸­çš„ fdï¼Œä¸€æ˜¯ç”¨äºåœ¨ select è¿”å›åï¼Œarray ä½œä¸ºæºæ•°æ®å’Œ fd_set è¿›è¡Œ FD_ISSET åˆ¤æ–­ã€‚äºŒæ˜¯ select è¿”å›åä¼šæŠŠä»¥å‰åŠ å…¥çš„ä½†å¹¶æ— äº‹ä»¶å‘ç”Ÿçš„ fd æ¸…ç©ºï¼Œåˆ™æ¯æ¬¡å¼€å§‹ select å‰éƒ½è¦é‡æ–°ä» array å–å¾— fd é€ä¸€åŠ å…¥ï¼ˆFD_ZERO æœ€å…ˆï¼‰ï¼Œæ‰«æ array çš„åŒæ—¶å–å¾— fd æœ€å¤§å€¼ maxfdï¼Œç”¨äº select çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¯è§ select æ¨¡å‹å¿…é¡»åœ¨ select å‰å¾ªç¯ arrayï¼ˆåŠ  fdï¼Œå– maxfdï¼‰ï¼Œselect è¿”å›åå¾ªç¯ arrayï¼ˆFD_ISSET åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼‰
  
- selectä¼šå°†rsetå…¨é‡æ‹·è´åˆ°å†…æ ¸æ€ï¼Œç”±å†…æ ¸æ€åˆ¤è¯»rsetæ˜¯å¦æœ‰æ•°æ®ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœç”±ç”¨æˆ·æ€åˆ¤æ–­ï¼Œä¹Ÿæ˜¯äº¤ç»™å†…æ ¸æ€çœŸæ­£æ‰§è¡Œï¼Œæ¯ä¸€ä¸ªä½çš„åˆ¤æ–­éƒ½éœ€è¦ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ‰€ä»¥selectç›´æ¥å°†rsetæ‹·è´åˆ°å†…æ ¸æ€

æ‰€ä»¥ï¼Œselect æœ‰å¦‚ä¸‹çš„ç¼ºç‚¹ï¼š

- ç›‘å¬èƒ½åŠ›æœ‰é™ï¼šä½¿ç”¨ 32 ä¸ªæ•´æ•°çš„ 32 ä½ï¼Œå³ 32*32=1024 æ¥æ ‡è¯† fdï¼Œæœ€å¤šåªèƒ½ç›‘å¬ 1024 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¯è°ƒæ•´ï¼‰
  
- å†…å­˜æ‹·è´å¼€é”€å¤§ï¼šæ¯æ¬¡è°ƒç”¨ selectï¼Œéƒ½éœ€è¦æŠŠ fd é›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨ fd å¾ˆå¤šæ—¶ä¼šå¾ˆå¤§
  
- æ—¶é—´å¤æ‚åº¦ ğ‘‚(ğ‘›)ï¼šæ¯æ¬¡ kernel éƒ½éœ€è¦çº¿æ€§æ‰«ææ•´ä¸ª fd_setï¼Œæ‰€ä»¥éšç€ç›‘æ§çš„æè¿°ç¬¦ fd æ•°é‡å¢é•¿ï¼Œå…¶ I/O æ€§èƒ½ä¼šçº¿æ€§ä¸‹é™ï¼Œè€Œä¸”ï¼Œrsetä¸å¯é‡ç”¨ï¼Œæ¯æ¬¡å¾ªç¯éƒ½è¦å¯¹rsetç½®ç©ºå†èµ‹å€¼ï¼Œæ€§èƒ½æœ‰æŸè€—


# poll

å¯¹æ¯”selectï¼Œpoll çš„å®ç°å’Œ select éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯æè¿° fd é›†åˆçš„æ–¹å¼ä¸åŒï¼Œpoll ä½¿ç”¨ pollfd ç»“æ„è€Œä¸æ˜¯ select çš„ fd_set ç»“æ„ï¼Œ poll å‡½æ•°ä½¿ç”¨é“¾è¡¨å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œæ‘†è„±äº† 1024 çš„æ•°é‡ä¸Šé™ã€‚ä½†æ˜¯åŒæ ·éœ€è¦ä»ç”¨æˆ·æ€æ‹·è´æ‰€æœ‰çš„ fd åˆ°å†…æ ¸æ€ï¼Œä¹Ÿéœ€è¦çº¿æ€§éå†æ‰€æœ‰çš„ fd é›†åˆ

```c
// fdsæ˜¯ä¸€ä¸ªpollå‡½æ•°ç›‘å¬çš„ç»“æ„åˆ—è¡¨ï¼Œnfdsè¡¨ç¤ºfdsæ•°ç»„çš„é•¿åº¦
// è¿”å›å€¼ï¼šå°äº0ï¼Œè¡¨ç¤ºå‡ºé”™ï¼Œç­‰äº0ï¼Œè¡¨ç¤ºpollå‡½æ•°ç­‰å¾…è¶…æ—¶ï¼Œå¤§äº0ï¼Œè¡¨ç¤ºstruct pollfdç»“æ„ä½“æ•°ç»„ä¸­æœ‰å¤šå°‘ä¸ªé0çš„reventsï¼Œä¹Ÿå°±æ˜¯è¿™ä¸€æ¬¡è°ƒç”¨polläº§ç”Ÿäº‹ä»¶çš„æè¿°ç¬¦çš„æ•°é‡ã€‚
int poll (struct pollfd *fds, unsigned int nfds, int timeout);
```

ä¸selectä¸åŒï¼Œpollä¼ å…¥çš„æ˜¯pollfdç»“æ„ä½“æ•°ç»„ï¼Œæ‰€ä»¥æ²¡æœ‰1024ä¸ªæè¿°ç¬¦çš„é™åˆ¶

```c
struct pollfd {
      int fd; // æ–‡ä»¶æè¿°ç¬¦
      short events; // å…³å¿ƒçš„äº‹ä»¶ç±»å‹
      short revents; // å®é™…å‘ç”Ÿäº†çš„äº‹ä»¶ç±»å‹
};
```

ä¸‹é¢æ˜¯pollçš„ä¾‹å­ï¼Œä¸selectç”¨æ³•ç›¸ä¼¼ï¼Œä»ç„¶éœ€è¦ä»ç”¨æˆ·æ€æ‹·è´æ‰€æœ‰çš„ fd åˆ°å†…æ ¸æ€ï¼Œä¹Ÿéœ€è¦çº¿æ€§éå†æ‰€æœ‰çš„ fd é›†åˆ

```c
// 5ä¸ªæ–‡ä»¶æè¿°ç¬¦
 for (i=0;i<5;i++) 
 {
   memset(&client, 0, sizeof (client));
   addrlen = sizeof(client);
   // å£°æ˜æ–‡ä»¶æè¿°ç¬¦
   pollfds[i].fd = accept(sockfd,(struct sockaddr*)&client, &addrlen);
   // eventsæ˜¯è¯»äº‹ä»¶
   pollfds[i].events = POLLIN;
 }
 sleep(1);
 while(1){
 puts("round again");
 // ä¼ å…¥pollfdæ•°ç»„ï¼Œå¹¶ä¸”æ•°ç»„ä¸­æœ‰5ä¸ªå…ƒç´ ï¼Œ50000æ˜¯è¶…æ—¶
poll(pollfds, 5, 50000);

for(i=0;i<5;i++) {
   // åˆ¤æ–­reventsæ˜¯å¦è¢«ç½®ä½ä¸ºPOLLIN
	if (pollfds[i].revents & POLLIN){
     // æ¢å¤ä¸º0
		pollfds[i].revents = 0;
		memset(buffer,0,MAXBUF);
		read(pollfds[i].fd, buffer, MAXBUF);
		puts(buffer);
	}
}
 }
```

ä¸selectä¸åŒçš„æ˜¯ï¼Œpollä¸æ˜¯å¯¹bitmapç½®ä½ï¼Œè€Œä¸”æ”¹å˜reventså­—æ®µï¼ˆselectå¯¹bitmapç½®ä½å¯¼è‡´rsetä¸å¯é‡ç”¨ï¼‰ï¼Œè¿™é‡Œä¼šå¯¹reventså­—æ®µèµ‹å€¼ä¸ºPOLLINï¼Œå³è¯»äº‹ä»¶ï¼Œpollè¿”å›åéœ€è¦å¯¹reventså­—æ®µæ¢å¤ä¸º0ã€‚pollè§£å†³äº†selectç›‘å¬èƒ½åŠ›å—é™çš„é—®é¢˜ï¼Œä¹Ÿè§£å†³äº†bitmapé‡ç”¨çš„é—®é¢˜ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦å†…å­˜æ‹·è´ä»¥åŠæ—¶é—´å¤æ‚åº¦ğ‘‚(ğ‘›)çš„é—®é¢˜ã€‚

# epoll

I/O å¤šè·¯å¤ç”¨çš„æ ¸å¿ƒè®¾è®¡æ˜¯ 1 ä¸ªçº¿ç¨‹å¤„ç†æ‰€æœ‰è¿æ¥çš„ ç­‰å¾…æ¶ˆæ¯å‡†å¤‡å¥½ I/O äº‹ä»¶ï¼Œè¿™ä¸€ç‚¹ä¸Š epoll å’Œ select&poll æ˜¯å¤§åŒå°å¼‚çš„ã€‚ä½† select&pollåœ¨åä¸‡å¹¶å‘è¿æ¥å­˜åœ¨æ—¶ï¼Œå¯èƒ½æ¯ä¸€æ¯«ç§’åªæœ‰æ•°ç™¾ä¸ªæ´»è·ƒçš„è¿æ¥ï¼ŒåŒæ—¶å…¶ä½™æ•°åä¸‡è¿æ¥åœ¨è¿™ä¸€æ¯«ç§’æ˜¯éæ´»è·ƒçš„ã€‚select&&poll çš„ä½¿ç”¨æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š è¿”å›çš„æ´»è·ƒè¿æ¥ == select(å…¨éƒ¨å¾…ç›‘æ§çš„è¿æ¥) ã€‚ä»€ä¹ˆæ—¶å€™ä¼šè°ƒç”¨ select&poll å‘¢ï¼Ÿåœ¨ä½ è®¤ä¸ºéœ€è¦æ‰¾å‡ºæœ‰æŠ¥æ–‡åˆ°è¾¾çš„æ´»è·ƒè¿æ¥æ—¶ï¼Œå°±åº”è¯¥è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œselect&poll åœ¨é«˜å¹¶å‘æ—¶æ˜¯ä¼šè¢«é¢‘ç¹è°ƒç”¨çš„ã€‚è¿™æ ·ï¼Œè¿™ä¸ªé¢‘ç¹è°ƒç”¨çš„æ–¹æ³•å°±å¾ˆæœ‰å¿…è¦çœ‹çœ‹å®ƒæ˜¯å¦æœ‰æ•ˆç‡ï¼Œå› ä¸ºï¼Œå®ƒçš„è½»å¾®æ•ˆç‡æŸå¤±éƒ½ä¼šè¢« é«˜é¢‘ äºŒå­—æ‰€æ”¾å¤§ã€‚å®ƒæœ‰æ•ˆç‡æŸå¤±å—ï¼Ÿæ˜¾è€Œæ˜“è§ï¼Œå…¨éƒ¨å¾…ç›‘æ§è¿æ¥æ˜¯æ•°ä»¥åä¸‡è®¡çš„ï¼Œè¿”å›çš„åªæ˜¯æ•°ç™¾ä¸ªæ´»è·ƒè¿æ¥ï¼Œè¿™æœ¬èº«å°±æ˜¯æ— æ•ˆç‡çš„è¡¨ç°ã€‚è¢«æ”¾å¤§åå°±ä¼šå‘ç°ï¼Œå¤„ç†å¹¶å‘ä¸Šä¸‡ä¸ªè¿æ¥æ—¶ï¼Œselect&poll å°±å®Œå…¨åŠ›ä¸ä»å¿ƒäº†ã€‚è¿™ä¸ªæ—¶å€™å°±è¯¥ epoll ä¸Šåœºäº†ï¼Œepoll é€šè¿‡ä¸€äº›æ–°çš„è®¾è®¡å’Œä¼˜åŒ–ï¼ŒåŸºæœ¬ä¸Šè§£å†³äº† select&poll çš„é—®é¢˜ã€‚

epoll çš„ API éå¸¸ç®€æ´ï¼Œæ¶‰åŠåˆ°çš„åªæœ‰ 3 ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š

```c
#include <sys/epoll.h>  
// sizeè¡¨æ˜å†…æ ¸è¦ç›‘å¬çš„æè¿°ç¬¦æ•°é‡
// è¿”å›ä¸€ä¸ªepollå¥æŸ„æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å›-1
int epoll_create(int size); // int epoll_create1(int flags);
// epfd è¡¨ç¤ºepollå¥æŸ„
// op è¡¨ç¤ºfdæ“ä½œç±»å‹ï¼Œæœ‰å¦‚ä¸‹3ç§ï¼š
// 1.EPOLL_CTL_ADD æ³¨å†Œæ–°çš„fdåˆ°epfdä¸­
// 2.EPOLL_CTL_MOD ä¿®æ”¹å·²æ³¨å†Œçš„fdçš„ç›‘å¬äº‹ä»¶
// 3.EPOLL_CTL_DEL ä»epfdä¸­åˆ é™¤ä¸€ä¸ªfd
// fd æ˜¯è¦ç›‘å¬çš„æè¿°ç¬¦
// event è¡¨ç¤ºè¦ç›‘å¬çš„äº‹ä»¶
int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);
// epfd æ˜¯epollå¥æŸ„
// events è¡¨ç¤ºä»å†…æ ¸å¾—åˆ°çš„å°±ç»ªäº‹ä»¶é›†åˆ
// maxevents å‘Šè¯‰å†…æ ¸eventsçš„å¤§å°
// timeout è¡¨ç¤ºç­‰å¾…çš„è¶…æ—¶äº‹ä»¶
// è¿”å›å€¼ï¼šè¿”å›å°±ç»ªçš„äº‹ä»¶æ•°ç›®ï¼Œè°ƒç”¨å¤±è´¥æ—¶è¿”å› -1ï¼Œç­‰å¾…è¶…æ—¶è¿”å› 0ã€‚
int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);
```

epoll_create åˆ›å»ºä¸€ä¸ª epoll å®ä¾‹å¹¶è¿”å› epollfdï¼Œepoll_ctl æ³¨å†Œ file descriptor ç­‰å¾…çš„ I/O äº‹ä»¶(æ¯”å¦‚ EPOLLINã€EPOLLOUT ç­‰) åˆ° epoll å®ä¾‹ä¸Šï¼Œepoll_wait åˆ™æ˜¯é˜»å¡ç›‘å¬ epoll å®ä¾‹ä¸Šæ‰€æœ‰çš„ file descriptor çš„ I/O äº‹ä»¶ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªç”¨æˆ·ç©ºé—´ä¸Šçš„ä¸€å—å†…å­˜åœ°å€ (events æ•°ç»„)ï¼Œkernel ä¼šåœ¨æœ‰ I/O äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™æŠŠæ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨å¤åˆ¶åˆ°è¿™å—å†…å­˜åœ°å€ä¸Šï¼Œç„¶å epoll_wait è§£é™¤é˜»å¡å¹¶è¿”å›ï¼Œæœ€åç”¨æˆ·ç©ºé—´ä¸Šçš„ç¨‹åºå°±å¯ä»¥å¯¹ç›¸åº”çš„ fd è¿›è¡Œè¯»å†™äº†ã€‚

epollèƒ½æ˜¾è‘—æé«˜ç¨‹åºåœ¨å¤§é‡å¹¶å‘è¿æ¥ä¸­åªæœ‰å°‘é‡æ´»è·ƒçš„æƒ…å†µä¸‹çš„ç³»ç»ŸCPUåˆ©ç”¨ç‡ã€‚åŸå› å°±æ˜¯è·å–äº‹ä»¶çš„æ—¶å€™ï¼Œå®ƒæ— é¡»éå†æ•´ä¸ªè¢«ä¾¦å¬çš„æè¿°ç¬¦é›†ï¼Œåªè¦éå†é‚£äº›è¢«å†…æ ¸IOäº‹ä»¶å¼‚æ­¥å”¤é†’è€ŒåŠ å…¥Readyé˜Ÿåˆ—çš„æè¿°ç¬¦é›†åˆå°±è¡Œäº†ã€‚

```c
struct epoll_event events[5];
  int epfd = epoll_create(10);
  ...
  ...
  for (i=0;i<5;i++) 
  {
    static struct epoll_event ev;
    memset(&client, 0, sizeof (client));
    addrlen = sizeof(client);
    ev.data.fd = accept(sockfd,(struct sockaddr*)&client, &addrlen);
    ev.events = EPOLLIN;
    epoll_ctl(epfd, EPOLL_CTL_ADD, ev.data.fd, &ev); 
  }
  
  while(1){
  	puts("round again");
  	nfds = epoll_wait(epfd, events, 5, 10000);
	
	for(i=0;i<nfds;i++) {
			memset(buffer,0,MAXBUF);
      // ä»eventsæ•°ç»„ä¸­è·å–å¯¹åº”fdå³å¯ï¼Œæ— éœ€éå†æ‰€æœ‰æè¿°ç¬¦é›†
			read(events[i].data.fd, buffer, MAXBUF);
			puts(buffer);
	}
  }
```

epoll çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

![img](./assets/image-20220323111526932.png)

ä¸ select&poll ç›¸æ¯”ï¼Œepoll åˆ†æ¸…äº†é«˜é¢‘è°ƒç”¨å’Œä½é¢‘è°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œepoll_ctl ç›¸å¯¹æ¥è¯´å°±æ˜¯éé¢‘ç¹è°ƒç”¨çš„ï¼Œè€Œ epoll_wait åˆ™æ˜¯ä¼šè¢«é«˜é¢‘è°ƒç”¨çš„ã€‚æ‰€ä»¥ epoll åˆ©ç”¨ epoll_ctl æ¥æ’å…¥æˆ–è€…åˆ é™¤ä¸€ä¸ª fdï¼Œå®ç°ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„æ•°æ®æ‹·è´ï¼Œè¿™ç¡®ä¿äº†æ¯ä¸€ä¸ª fd åœ¨å…¶ç”Ÿå‘½å‘¨æœŸåªéœ€è¦è¢«æ‹·è´ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯æ¬¡è°ƒç”¨ epoll_wait çš„æ—¶å€™éƒ½æ‹·è´ä¸€æ¬¡ã€‚ epoll_wait åˆ™è¢«è®¾è®¡æˆå‡ ä¹æ²¡æœ‰å…¥å‚çš„è°ƒç”¨ï¼Œç›¸æ¯” select&polléœ€è¦æŠŠå…¨éƒ¨ç›‘å¬çš„ fd é›†åˆä»ç”¨æˆ·æ€æ‹·è´è‡³å†…æ ¸æ€çš„åšæ³•ï¼Œepoll çš„æ•ˆç‡å°±é«˜å‡ºäº†ä¸€å¤§æˆªã€‚

åœ¨å®ç°ä¸Š epoll é‡‡ç”¨çº¢é»‘æ ‘æ¥å­˜å‚¨æ‰€æœ‰ç›‘å¬çš„ fdï¼Œ**è€Œçº¢é»‘æ ‘æœ¬èº«æ’å…¥å’Œåˆ é™¤æ€§èƒ½æ¯”è¾ƒç¨³å®šï¼Œæ—¶é—´å¤æ‚åº¦ O(logN)ã€‚** é€šè¿‡ epoll_ctl å‡½æ•°æ·»åŠ è¿›æ¥çš„ fd éƒ½ä¼šè¢«æ”¾åœ¨çº¢é»‘æ ‘çš„æŸä¸ªèŠ‚ç‚¹å†…ï¼Œæ‰€ä»¥ï¼Œé‡å¤æ·»åŠ æ˜¯æ²¡æœ‰ç”¨çš„ã€‚å½“æŠŠ fd æ·»åŠ è¿›æ¥çš„æ—¶å€™æ—¶å€™ä¼šå®Œæˆå…³é”®çš„ä¸€æ­¥ï¼šè¯¥ fd ä¼šä¸ç›¸åº”çš„è®¾å¤‡ï¼ˆç½‘å¡ï¼‰é©±åŠ¨ç¨‹åºå»ºç«‹å›è°ƒå…³ç³»ï¼Œä¹Ÿå°±æ˜¯åœ¨å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºä¸ºå®ƒæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨ fd ç›¸åº”çš„äº‹ä»¶è§¦å‘ï¼ˆä¸­æ–­ï¼‰ä¹‹åï¼ˆè®¾å¤‡å°±ç»ªäº†ï¼‰ï¼Œå†…æ ¸å°±ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°åœ¨å†…æ ¸ä¸­è¢«ç§°ä¸ºï¼šep_poll_callbackï¼Œ**è¿™ä¸ªå›è°ƒå‡½æ•°å…¶å®å°±æ˜¯æŠŠè¿™ä¸ª fd æ·»åŠ åˆ° rdllist è¿™ä¸ªåŒå‘é“¾è¡¨ï¼ˆå°±ç»ªé“¾è¡¨ï¼‰ä¸­ã€‚** epoll_wait å®é™…ä¸Šå°±æ˜¯å»æ£€æŸ¥ rdllist åŒå‘é“¾è¡¨ä¸­æ˜¯å¦æœ‰å°±ç»ªçš„ fdï¼Œå½“ rdllist ä¸ºç©ºï¼ˆæ— å°±ç»ª fdï¼‰æ—¶æŒ‚èµ·å½“å‰è¿›ç¨‹ï¼Œç›´åˆ° rdllist éç©ºæ—¶è¿›ç¨‹æ‰è¢«å”¤é†’å¹¶è¿”å›ã€‚

ç›¸æ¯”äº select&poll è°ƒç”¨æ—¶ä¼šå°†å…¨éƒ¨ç›‘å¬çš„ fd ä»ç”¨æˆ·æ€ç©ºé—´æ‹·è´è‡³å†…æ ¸æ€ç©ºé—´å¹¶çº¿æ€§æ‰«æä¸€éæ‰¾å‡ºå°±ç»ªçš„ fd å†è¿”å›åˆ°ç”¨æˆ·æ€ï¼Œepoll_wait åˆ™æ˜¯ç›´æ¥è¿”å›å·²å°±ç»ª fdï¼Œå› æ­¤ epoll çš„ I/O æ€§èƒ½ä¸ä¼šåƒ select&poll é‚£æ ·éšç€ç›‘å¬çš„ fd æ•°é‡å¢åŠ è€Œå‡ºç°çº¿æ€§è¡°å‡ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é«˜æ•ˆçš„ I/O äº‹ä»¶é©±åŠ¨æŠ€æœ¯ã€‚

ç”±äºä½¿ç”¨ epoll çš„ I/O å¤šè·¯å¤ç”¨éœ€è¦ç”¨æˆ·è¿›ç¨‹è‡ªå·±è´Ÿè´£ I/O è¯»å†™ï¼Œä»ç”¨æˆ·è¿›ç¨‹çš„è§’åº¦çœ‹ï¼Œè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥ select&poll&epoll æœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ï¼Œè€Œåƒ Windows çš„ IOCP è¿™ä¸€ç±»çš„å¼‚æ­¥ I/Oï¼Œåªéœ€è¦åœ¨è°ƒç”¨ WSARecv æˆ– WSASend æ–¹æ³•è¯»å†™æ•°æ®çš„æ—¶å€™æŠŠç”¨æˆ·ç©ºé—´çš„å†…å­˜ buffer æäº¤ç»™ kernelï¼Œkernel è´Ÿè´£æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ‹·è´ï¼Œå®Œæˆä¹‹åå°±ä¼šé€šçŸ¥ç”¨æˆ·è¿›ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦ç”¨æˆ·è¿›ç¨‹å‚ä¸ï¼Œæ‰€ä»¥æ˜¯çœŸæ­£çš„å¼‚æ­¥ I/Oã€‚


**epoll çš„å·¥ä½œæ¨¡å¼:**

epollå¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œæœ‰ä¸¤ç§æ¨¡å¼ï¼šLTï¼ˆlevel triggerï¼‰å’ŒETï¼ˆedge triggerï¼‰ã€‚LTæ¨¡å¼æ˜¯é»˜è®¤æ¨¡å¼ï¼ŒLTæ¨¡å¼ä¸ETæ¨¡å¼çš„åŒºåˆ«å¦‚ä¸‹ï¼š

- LTæ¨¡å¼ï¼šå½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä¸ç«‹å³å¤„ç†è¯¥äº‹ä»¶ã€‚ä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶ã€‚
  
- ETæ¨¡å¼ï¼šå½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶ã€‚å¦‚æœä¸å¤„ç†ï¼Œä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¸ä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶ã€‚

**è¾¹ç¼˜è§¦å‘æ¨¡å¼çš„æ„ä¹‰ï¼š**

è‹¥ç”¨æ°´å¹³è§¦å‘ï¼Œç³»ç»Ÿä¸­ä¸€æ—¦æœ‰å¤§é‡æ— éœ€è¯»å†™çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒä»¬æ¯æ¬¡è°ƒç”¨epoll_waitéƒ½ä¼šè¿”å›ï¼Œè¿™å¤§å¤§é™ä½å¤„ç†ç¨‹åºæ£€ç´¢è‡ªå·±å…³å¿ƒçš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„æ•ˆç‡ã€‚ è€Œé‡‡ç”¨è¾¹ç¼˜è§¦å‘ï¼Œå½“è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰å¯è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œepoll_waitä¼šé€šçŸ¥å¤„ç†ç¨‹åºå»è¯»å†™ã€‚å¦‚æœè¿™æ¬¡æ²¡æœ‰æŠŠæ•°æ®å…¨éƒ¨è¯»å†™å®Œ(å¦‚è¯»å†™ç¼“å†²åŒºå¤ªå°)ï¼Œé‚£ä¹ˆä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œå®ƒä¸ä¼šé€šçŸ¥ä½ ï¼Œå³åªä¼šé€šçŸ¥ä½ ä¸€æ¬¡ï¼Œç›´åˆ°è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸Šå‡ºç°ç¬¬äºŒæ¬¡å¯è¯»å†™äº‹ä»¶æ‰ä¼šé€šçŸ¥ä½ ã€‚è¿™æ¯”æ°´å¹³è§¦å‘æ•ˆç‡é«˜ï¼Œç³»ç»Ÿä¸ä¼šå……æ–¥å¤§é‡ä½ ä¸å…³å¿ƒçš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦ã€‚

::: tip æç¤º

epollä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„çº¢é»‘æ ‘rbtï¼Œå’Œä¸€ä¸ªå°±ç»ªåˆ—è¡¨ready-listã€‚

è°ƒç”¨epoll_waitæ—¶å…¶å®å°±æ˜¯ä»ready-listä¸­æ‹¿æ•°æ®ï¼Œ

ä¸€èˆ¬è¯´æ¥ä»ready-listä¸­æ¯æ‹¿ä¸€ä¸ªäº‹ä»¶å°±åˆ é™¤ä¸€ä¸ªäº‹ä»¶ï¼Œ

ä½†å¦‚æœæ‹¿åˆ°çš„äº‹ä»¶æ˜¯æ°´å¹³è§¦å‘ï¼Œå®ƒä¼šæ”¾å›read-listã€‚

:::