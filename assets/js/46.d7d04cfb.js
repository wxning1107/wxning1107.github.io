(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{1502:function(e,s,t){"use strict";t.r(s);var i=t(15),a=Object(i.a)({},(function(){var e=this,s=e.$createElement,i=e._self._c||s;return i("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[i("h1",{attrs:{id:"é«˜å¹¶å‘æœåŠ¡é‡-redis-ç“¶é¢ˆå¼•å‘çš„äº‹æ•…"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#é«˜å¹¶å‘æœåŠ¡é‡-redis-ç“¶é¢ˆå¼•å‘çš„äº‹æ•…"}},[e._v("#")]),e._v(" é«˜å¹¶å‘æœåŠ¡é‡ redis ç“¶é¢ˆå¼•å‘çš„äº‹æ•…")]),e._v(" "),i("p",[e._v("å…ƒæ—¦æœŸé—´ è®¢å•ä¸šåŠ¡çº¿ å‘ŠçŸ¥ æ¨é€ç³»ç»Ÿ æ— æ³•æ­£å¸¸æ”¶å‘æ¶ˆæ¯ï¼Œä½œä¸ºæ¨é€ç³»ç»Ÿç»´æŠ¤è€…çš„æˆ‘æ­£å¤–é¢æ½‡æ´’ï¼Œæ— æ³•ç¬¬ä¸€æ—¶é—´å›å»ï¼Œç›´æ¥è®© ops å¸®å¿™é‡å¯æœåŠ¡ï¼Œä¸€åˆ‡å¥½äº†èµ·æ¥ï¼Œé‡å¯æœç„¶æ˜¯ä¸ªå¤§æ€å™¨ã€‚ç”±äºæ¨é€ç³»ç»Ÿæœ¬èº«æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæ¶ˆæ¯æœ‰åšå„ç§çš„å¯é æ€§ç­–ç•¥ï¼Œæ‰€ä»¥é‡å¯æ˜¯ä¸ä¼šä¸¢å¤±æ¶ˆæ¯äº‹ä»¶çš„ã€‚")]),e._v(" "),i("p",[e._v("ğŸ˜… äº‹åé€šè¿‡æ—¥å¿—åˆ†ææœ‰å¤§é‡çš„ redis çš„æŠ¥é”™ï¼Œååˆ†é’Ÿå†…æœ‰ 16w æ¬¡çš„é”™è¯¯ã€‚æ—¥å¿—çš„é”™è¯¯æ˜¯ connect: cannot assign requested address ã€‚è¯¥é”™è¯¯ä¸æ˜¯æ¨é€æœåŠ¡å†…éƒ¨åŠ redis åº“è¿”å›çš„ errorï¼Œè€Œæ˜¯ç³»ç»Ÿå›é¦ˆçš„ errno é”™è¯¯ã€‚")]),e._v(" "),i("p",[e._v("è¿™ä¸ªé”™è¯¯æ˜¯ç”±äºæ— æ³•ç”³è¯·å¯ç”¨åœ°å€å¼•èµ·çš„ï¼Œä¹Ÿå°±æ˜¯æ— æ³•ç”³è¯·åˆ°å¯ç”¨çš„ socketã€‚")]),e._v(" "),i("p",[e._v("è¯è¯´ï¼Œå…ƒæ—¦å½“å¤©åœ¨çº¿æ•°å’Œè®¢å•é‡ç¡®å®å¤§äº†ä¸å°‘ï¼Œå¾€å¸¸æ¨é€ç³»ç»Ÿçš„é•¿è¿æ¥å®¢æˆ·ç«¯åœ¨ 35wï¼Œè¿™æ¬¡å³°å€¼é£™åˆ° 50w å·¦å³, é›†ç¾¤å…± 6 ä¸ªèŠ‚ç‚¹ï¼Œå…¶ä¸­æœ‰ 4 ä¸ªèŠ‚ç‚¹æ¯ä¸ªéƒ½æ‰›äº† 9w+ çš„é•¿è¿æ¥ã€‚å¦å¤–ï¼Œæ¨é€çš„æ¶ˆæ¯é‡ä¹Ÿéšä¹‹ç¿»å€ã€‚")]),e._v(" "),i("img",{staticStyle:{zoom:"50%"},attrs:{src:t(888),alt:"image-20220327161928203"}}),e._v(" "),i("p",[i("font",{attrs:{size:"5"}},[i("strong",[e._v("åˆ†æ")])])],1),e._v(" "),i("p",[e._v("ä¸‹é¢æ˜¯ kibana æ—¥å¿—çš„ç»Ÿè®¡ï¼Œå‡ºé”™çš„æ—¶é—´åŒºé—´é‡Œæœ‰è¿‘ 16w æ¬¡çš„ redis æŠ¥é”™ã€‚")]),e._v(" "),i("img",{staticStyle:{zoom:"50%"},attrs:{src:t(889),alt:"image-20220327161928203"}}),e._v(" "),i("p",[e._v("ä¸‹é¢æ˜¯å‡ºé—®é¢˜èŠ‚ç‚¹çš„ TCP è¿æ¥çŠ¶å†µï¼Œå¯ä»¥çœ‹åˆ° established åœ¨ 6wï¼Œè€Œtime-wait è¿æ¥å¹²åˆ° 2w å¤šä¸ªã€‚")]),e._v(" "),i("img",{staticStyle:{zoom:"50%"},attrs:{src:t(890),alt:"image-20220327161928203"}}),e._v(" "),i("p",[e._v("ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿè¿™ä¹ˆå¤š time-waitï¼Ÿè°ä¸»åŠ¨å…³é—­å°±å°±æœ‰ time-waitï¼Œä½†æ¨é€ç³»ç»Ÿé™¤äº†åè®®è§£æå¤±è´¥ä¹‹å¤–ï¼Œå…¶ä½™æƒ…å†µéƒ½ä¸ä¼šä¸»åŠ¨ close å®¢æˆ·ç«¯ï¼Œå“ªæ€•æ˜¯é‰´æƒå¤±è´¥å’Œå¼±ç½‘ç»œå®¢æˆ·ç«¯å†™ç¼“å†²çˆ†æ»¡ï¼Œäº‹åé€šè¿‡æ—¥å¿—ä¹Ÿç¡®å®šäº†ä¸æ˜¯æ¨é€ç³»ç»Ÿè‡ªèº«äº§ç”Ÿçš„ twã€‚")]),e._v(" "),i("p",[e._v("å¦å¤–ï¼Œlinux ä¸»æœºè¢« ops äº¤ä»˜æ—¶åº”è¯¥æœ‰åšå†…æ ¸è°ƒä¼˜åˆå§‹åŒ–çš„ï¼Œåœ¨å¼€å¯ tw_reuse å‚æ•°åï¼Œtime-wait æ˜¯å¯ä»¥å¤ç”¨çš„ã€‚éš¾é“æ˜¯æ²¡å¼€å¯ reuseï¼Ÿ")]),e._v(" "),i("p",[e._v("æŸ¥çœ‹ sysctl.conf çš„å†…æ ¸å‚æ•°å¾—çŸ¥ï¼Œæœç„¶ tcp_tw_reuse å‚æ•°æ²¡æœ‰æ‰“å¼€ï¼Œä¸èƒ½å¿«é€Ÿåœ°å¤ç”¨è¿˜å¤„åœ¨ time-wait çŠ¶æ€çš„åœ°å€ï¼Œåªèƒ½ç­‰å¾… time-wait çš„è¶…æ—¶å…³é—­ï¼Œrfc åè®®é‡Œè§„å®šç­‰å¾… 2 åˆ†é’Ÿå·¦å³ï¼Œå¼€å¯ tw_reuseå¯åœ¨ 1s åå¤ç”¨è¯¥åœ°å€ã€‚å¦å¤– ip_local_port_range ç«¯å£èŒƒå›´ä¹Ÿä¸å¤§ï¼Œç¼©çŸ­äº†å¯ç”¨çš„è¿æ¥èŒƒå›´ã€‚")]),e._v(" "),i("div",{staticClass:"language- line-numbers-mode"},[i("pre",{pre:!0,attrs:{class:"language-text"}},[i("code",[e._v('sysctl  -a|egrep "tw_reuse|timestamp|local_port"\n\nnet.ipv4.ip_local_port_range = 35768    60999\nnet.ipv4.tcp_timestamps = 1\nnet.ipv4.tcp_tw_reuse = 0\n')])]),e._v(" "),i("div",{staticClass:"line-numbers-wrapper"},[i("span",{staticClass:"line-number"},[e._v("1")]),i("br"),i("span",{staticClass:"line-number"},[e._v("2")]),i("br"),i("span",{staticClass:"line-number"},[e._v("3")]),i("br"),i("span",{staticClass:"line-number"},[e._v("4")]),i("br"),i("span",{staticClass:"line-number"},[e._v("5")]),i("br")])]),i("p",[e._v("æ‰€ä»¥ï¼Œç”±äºæ²¡æœ‰å¯ç”¨åœ°å€æ‰çˆ†å‡ºäº† connect: cannot assign requested address é”™è¯¯ã€‚")]),e._v(" "),i("p",[i("font",{attrs:{size:"5"}},[i("strong",[e._v("å†…åœ¨é—®é¢˜")])])],1),e._v(" "),i("p",[i("strong",[e._v("è¿½ç©¶é—®é¢˜")])]),e._v(" "),i("p",[e._v("ä¸Šé¢æ˜¯è¡¨è±¡é—®é¢˜ï¼Œæ¥æŸ¥æŸ¥ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¤šçš„ time-wait ï¼Ÿå†è¯´ä¸€éï¼Œé€šå¸¸å“ªä¸€ç«¯ä¸»åŠ¨ close fdï¼Œå“ªä¸€ç«¯å°±ä¼šäº§ç”Ÿ time-waitã€‚"),i("strong",[e._v("äº‹åé€šè¿‡ netstat å¾—çŸ¥ time-wait è¿æ¥åŸºæœ¬æ˜¯æ¥è‡ª redis ä¸»æœºã€‚")])]),e._v(" "),i("p",[e._v("ä¸‹é¢æ˜¯æ¨é€ä»£ç ä¸­çš„è¿æ¥æ± é…ç½®ï¼Œç©ºé—²è¿æ¥æ± åªæœ‰ 50ï¼Œæœ€å¤§å¯ä»¥ new çš„è¿æ¥å¯ä»¥åˆ° 500 ä¸ªã€‚è¿™ä»£è¡¨å½“æœ‰å¤§é‡è¯·æ±‚æ—¶ï¼Œä¼å›¾å…ˆä» size ä¸º 50 çš„è¿æ¥æ± é‡Œè·å–è¿æ¥ï¼Œå¦‚æœæ‹¿ä¸åˆ°è¿æ¥åˆ™ new ä¸€ä¸ªæ–°è¿æ¥ï¼Œè¿æ¥ç”¨å®Œäº†åéœ€è¦å½’è¿˜è¿æ¥æ± ï¼Œå¦‚æœè¿™æ—¶å€™è¿æ¥æ± å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆè¯¥è¿æ¥ä¼šä¸»åŠ¨è¿›è¡Œ close å…³é—­ã€‚")]),e._v(" "),i("div",{staticClass:"language- line-numbers-mode"},[i("pre",{pre:!0,attrs:{class:"language-text"}},[i("code",[e._v("MaxIdle   = 50\nMaxActive = 500\nWait      = false\n")])]),e._v(" "),i("div",{staticClass:"line-numbers-wrapper"},[i("span",{staticClass:"line-number"},[e._v("1")]),i("br"),i("span",{staticClass:"line-number"},[e._v("2")]),i("br"),i("span",{staticClass:"line-number"},[e._v("3")]),i("br")])]),i("p",[e._v("é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å‘ç°ä¸€ä¸ªé—®é¢˜ã€‚æœ‰å‡ å¤„ redis çš„å¤„ç†é€»è¾‘æ˜¯å¼‚æ­¥çš„ï¼Œæ¯”å¦‚æ¯æ¬¡æ”¶åˆ°å¿ƒè·³åŒ…éƒ½ä¼š go ä¸€ä¸ªåç¨‹å»æ›´æ–° redis, è¿™ä¹ŸåŠ å‰§äº†è¿æ¥æ± çš„æŠ¢å¤ºï¼Œæ”¹ä¸ºåŒæ­¥ä»£ç ã€‚è¿™æ ·åœ¨ä¸€ä¸ªè¿æ¥ä¸Šä¸‹æ–‡ä¸­åŒæ—¶åªå¯¹ä¸€ä¸ª redis è¿æ¥æ“ä½œã€‚")]),e._v(" "),i("p",[i("strong",[e._v("è§£å†³æ–¹æ³•")])]),e._v(" "),i("p",[e._v('è°ƒå¤§ golang redis client çš„ maxIdle è¿æ¥æ± å¤§å°ï¼Œé¿å…äº†å¤§å¹¶å‘ä¸‹æ— ç©ºé—²è¿æ¥è€Œæ–°å»ºè¿æ¥å’Œæ± å­çˆ†æ»¡åˆä¸èƒ½å½’è¿˜è¿æ¥çš„å°´å°¬åœºé¢ã€‚å½“ pool wait ä¸º true æ—¶ï¼Œæ„å‘³ç€å¦‚æœç©ºé—²æ± ä¸­æ²¡æœ‰å¯ç”¨çš„è¿æ¥ï¼Œä¸”å½“å‰å·²å»ºç«‹è¿æ¥çš„è¿æ¥æ•°å¤§äº MaxActive æœ€å¤§ç©ºé—²æ•°ï¼Œåˆ™ä¸€ç›´é˜»å¡ç­‰å¾…å…¶ä»–äººå½’è¿˜è¿æ¥ã€‚åä¹‹ç›´æ¥è¿”å› "connection pool exhausted" é”™è¯¯ã€‚')]),e._v(" "),i("div",{staticClass:"language- line-numbers-mode"},[i("pre",{pre:!0,attrs:{class:"language-text"}},[i("code",[e._v("MaxIdle   = 300\nMaxActive = 400\nWait      = true\n")])]),e._v(" "),i("div",{staticClass:"line-numbers-wrapper"},[i("span",{staticClass:"line-number"},[e._v("1")]),i("br"),i("span",{staticClass:"line-number"},[e._v("2")]),i("br"),i("span",{staticClass:"line-number"},[e._v("3")]),i("br")])]),i("p",[i("font",{attrs:{size:"5"}},[i("strong",[e._v("redis çš„ qps æ€§èƒ½ç“¶é¢ˆ")])])],1),e._v(" "),i("p",[e._v("redis çš„æ€§èƒ½ä¸€ç›´æ˜¯å¤§å®¶æ‰€ç§°èµçš„ï¼Œåœ¨ä¸ä½¿ç”¨ redis 6.0 multi io thread ä¸‹ï¼ŒQPS ä¸€èˆ¬å¯ä»¥åœ¨ 13w å·¦å³ï¼Œå¦‚æœä½¿ç”¨å¤šæŒ‡ä»¤å’Œ pipeline çš„è¯ï¼Œå¯ä»¥å¹²åˆ° 40w çš„ OPS å‘½ä»¤æ•°ï¼Œå½“ç„¶ qps è¿˜æ˜¯åœ¨ 12w-13w å·¦å³ã€‚")]),e._v(" "),i("blockquote",[i("p",[e._v("Redis QPS é«˜ä½è·Ÿ redis ç‰ˆæœ¬å’Œ cpu hzã€cache å­˜åœ¨æ­£æ¯”å…³ç³»")])]),e._v(" "),i("p",[e._v("æ ¹æ®æˆ‘çš„ç»éªŒï¼Œåœ¨å†…ç½‘ç¯å¢ƒä¸‹ä¸”å·²å®ä¾‹åŒ–è¿æ¥å¯¹è±¡ï¼Œå•æ¡ redis æŒ‡ä»¤è¯·æ±‚è€—æ—¶é€šå¸¸åœ¨ 0.2ms å·¦å³ï¼Œ200us å·²ç»å¤Ÿå¿«äº†ï¼Œä½†ä¸ºä»€ä¹ˆè¿˜ä¼šæœ‰å¤§é‡å›  redis client è¿æ¥æ± æ— ç©ºé—²è¿æ¥è€Œå»ºç«‹æ–°è¿æ¥çš„æƒ…å†µï¼Ÿ")]),e._v(" "),i("p",[e._v("é€šè¿‡ grafana ç›‘æ§åˆ†æ redis é›†ç¾¤ï¼Œå‘ç°æœ‰å‡ ä¸ªèŠ‚ç‚¹ QPS å·²ç»åˆ°äº† Redis å•å®ä¾‹æ€§èƒ½ç“¶é¢ˆï¼ŒQPS å¹²åˆ°äº†è¿‘ 15w å·¦å³ã€‚éš¾æ€ªä¸èƒ½å¿«é€Ÿå¤„ç†æ¥è‡ªä¸šåŠ¡çš„ redis è¯·æ±‚ã€‚è¿™ä¸ªç“¶é¢ˆå¿…ç„¶ä¼šå½±å“è¯·æ±‚çš„æ—¶å»¶ã€‚è¯·æ±‚çš„æ—¶å»¶éƒ½é«˜äº†ï¼Œè¿æ¥æ± ä¸èƒ½åŠæ—¶è¿”å›è¿æ¥æ± ï¼Œæ‰€ä»¥å°±é€ æˆäº†æ–‡ç« å¼€å¤´è¯´çš„é—®é¢˜ã€‚æ€»ä¹‹ï¼Œä¸šåŠ¡æµé‡çš„æš´å¢å¼•èµ·äº†ä¸€ç³»åˆ—é—®é¢˜ã€‚")]),e._v(" "),i("img",{staticStyle:{zoom:"50%"},attrs:{src:t(891),alt:"image-20220327161928203"}}),e._v(" "),i("p",[e._v("å‘ç°é—®é¢˜ï¼Œé‚£ä¹ˆå°±è¦è§£å†³é—®é¢˜ï¼Œredis çš„ qps ä¼˜åŒ–æ–¹æ¡ˆæœ‰ä¸¤æ­¥ï¼š")]),e._v(" "),i("ul",[i("li",[i("p",[e._v("æ‰©å®¹ redis èŠ‚ç‚¹ï¼Œè¿ç§» slot ä½¿å…¶åˆ†æ‹…æµé‡")])]),e._v(" "),i("li",[i("p",[e._v("å°½é‡æŠŠç¨‹åºä¸­ redis çš„è¯·æ±‚æ”¹æˆæ‰¹é‡æ¨¡å¼")])])]),e._v(" "),i("p",[e._v("å¢åŠ èŠ‚ç‚¹å®¹æ˜“ï¼Œæ‰¹é‡ä¹Ÿå®¹æ˜“ã€‚èµ·åˆåœ¨ä¼˜åŒ–æ¨é€ç³»ç»Ÿæ—¶ï¼Œå·²ç»æŠŠåŒä¸€ä¸ªé€»è¾‘ä¸­çš„ redis æ“ä½œæ”¹ä¸ºæ‰¹é‡æ¨¡å¼äº†ã€‚ä½†é—®é¢˜æ¥äº†ï¼Œå¾ˆå¤šçš„ redis æ“ä½œåœ¨ä¸åŒçš„é€»è¾‘å—é‡Œé¢ï¼Œæ²¡æ³•åˆæˆä¸€ä¸ª pipelineã€‚")]),e._v(" "),i("p",[e._v("ç„¶ååšäº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼ŒæŠŠä¸åŒé€»è¾‘ä¸­çš„ redis è¯·æ±‚åˆå¹¶åˆ°ä¸€ä¸ª pipeline é‡Œï¼Œä¼˜ç‚¹åœ¨äºæé«˜äº† redis çš„ååï¼Œå‡å°‘äº† socket ç³»ç»Ÿè°ƒç”¨ã€ç½‘ç»œä¸­æ–­å¼€é”€ï¼Œç¼ºç‚¹æ˜¯å¢åŠ äº†é€»è¾‘å¤æ‚åº¦ï¼Œä½¿ç”¨ channal ç®¡é“åšé˜Ÿåˆ—åŠé€šçŸ¥å¢åŠ äº† runtime è°ƒåº¦å¼€é”€ï¼Œpipeline worker è§¦å‘æ¡ä»¶æ˜¯æ»¡è¶³ 3 ä¸ª command æˆ– 5ms è¶…æ—¶ï¼Œå®šæ—¶å™¨é‡‡ç”¨åˆ†æ®µçš„æ—¶é—´è½®ã€‚")]),e._v(" "),i("p",[e._v("å¯¹æ¯”ä¼˜åŒ–ä¿®æ”¹å‰ï¼Œcpuå¼€é”€å‡å°‘äº† 3% å·¦å³ï¼Œredis qpsé™åˆ° 7w å·¦å³ï¼Œå½“ç„¶æ¦‚ç‡ä¸Šæ¶ˆæ¯çš„æ—¶å»¶ä¼šé«˜äº†å‡ ä¸ªmsã€‚")]),e._v(" "),i("p",[e._v("å®ç°çš„é€»è¾‘å‚è€ƒä¸‹å›¾ï¼Œè°ƒç”¨æ–¹æŠŠredis commandå’Œæ¥æ”¶ç»“æœçš„chanæ¨é€åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åç”±ä¸€ä¸ªworkerå»æ¶ˆè´¹ï¼Œworkerç»„è£…å¤šä¸ªredis cmdä¸ºpipelineï¼Œå‘rediså‘èµ·è¯·æ±‚å¹¶æ‹¿å›ç»“æœï¼Œæ‹†è§£ç»“æœé›†åï¼Œç»™æ¯ä¸ªå‘½ä»¤å¯¹åº”çš„ç»“æœchanæ¨é€ç»“æœã€‚è°ƒç”¨æ–¹åœ¨æ¨é€ä»»åŠ¡åˆ°é˜Ÿåˆ—åï¼Œå°±ä¸€ç›´ç›‘å¬ä¼ è¾“ç»“æœçš„chanã€‚")]),e._v(" "),i("img",{staticStyle:{zoom:"50%"},attrs:{src:t(892),alt:"image-20220327161928203"}})])}),[],!1,null,null,null);s.default=a.exports},888:function(e,s,t){e.exports=t.p+"assets/img/image-20220417155823141.2df8cd0e.png"},889:function(e,s,t){e.exports=t.p+"assets/img/image-20220417160002026.e47c979a.png"},890:function(e,s,t){e.exports=t.p+"assets/img/image-20220417160059212.6af2f9a7.png"},891:function(e,s,t){e.exports=t.p+"assets/img/image-20220417161856880.20b7b202.png"},892:function(e,s,t){e.exports=t.p+"assets/img/image-20220417162136657.513efe02.png"}}]);